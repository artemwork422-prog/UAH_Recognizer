# üêõ –í–∏–ø—Ä–∞–≤–ª–µ–Ω—ñ –ø–æ–º–∏–ª–∫–∏ —Ç–∞ –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó

## –í–µ—Ä—Å—ñ—è: v2.1 (19.02.2026)

### üî¥ –ö–†–ò–¢–ò–ß–ù–Ü –ü–†–û–ë–õ–ï–ú–ò (–í–ò–ü–†–ê–í–õ–ï–ù–û)

#### 1. **–ë–µ—Å–∫–æ–Ω–µ—á–Ω–∏–π —Ü–∏–∫–ª —É –≤–µ–±-—Å–µ—Ä–≤–µ—Ä—ñ**
- **–ü—Ä–æ–±–ª–µ–º–∞**: –§—É–Ω–∫—Ü—ñ—è `stream_handler()` –º–∞–ª–∞ `while (res == ESP_OK)` –±–µ–∑ —É–º–æ–≤–∏ –≤–∏—Ö–æ–¥—É, —Ü–µ –±–ª–æ–∫—É–≤–∞–ª–æ –≤–µ—Å—å –≤–µ–±-—Å–µ—Ä–≤–µ—Ä
- **–ù–∞—Å–ª—ñ–¥–æ–∫**: –ù–∞—Ç–∏—Å–∫–∞–Ω–Ω—è –∫–Ω–æ–ø–∫–∏ —É –≤–µ–±—ñ –Ω–µ –æ–±—Ä–æ–±–ª—è—î—Ç—å—Å—è, —Å–∏—Å—Ç–µ–º–∞ –∑–∞–≤–∏—Å–∞—î
- **–í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è**: 
  - –î–æ–¥–∞–Ω–æ —Ç–∞–π–º–∞—É—Ç 300 —Å–µ–∫—É–Ω–¥ –Ω–∞ —Å—Ç—Ä—ñ–º
  - –¶–∏–∫–ª —Ç–µ–ø–µ—Ä –≤–∏—Ö–æ–¥–∏—Ç—å –∫–æ–ª–∏ —á–∞—Å —Å—à—à—Å—Ç–µ–∫–∞—î –∞–±–æ –∑'—î–¥–Ω–∞–Ω–Ω—è —Ä–æ–∑—Ä–∏–≤–∞—î—Ç—å—Å—è
  ```cpp
  while ((res == ESP_OK) && ((millis() - stream_start) < STREAM_TIMEOUT))
  ```

#### 2. **–ö–æ–Ω—Ñ–ª—ñ–∫—Ç –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –∫–∞–¥—Ä—ñ–≤ –∫–∞–º–µ—Ä–∏**
- **–ü—Ä–æ–±–ª–µ–º–∞**: `runInference()` –æ—Ç—Ä–∏–º—É–≤–∞–≤ frame —è–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä –∞–ª–µ —ñ–≥–Ω–æ—Ä—É–≤–∞–≤ –π–æ–≥–æ —ñ –≤–∏–∫–ª–∏–∫–∞–≤ `esp_camera_fb_get()` –ø–æ–≤—Ç–æ—Ä–Ω–æ
- **–ù–∞—Å–ª—ñ–¥–æ–∫**: –î–≤–∞ –æ–¥–Ω–æ—á–∞—Å–Ω—ñ –∑–∞–ø–∏—Ç–∏ –¥–æ –∫–∞–º–µ—Ä–∏ —Å–æ–∑–¥–∞–≤–∞–ª–∏ deadlock, —Å–∏—Å—Ç–µ–º–∞ –∑–∞–≤–∏—Å–∞–ª–∞ –ø—Ä–∏ —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—è
- **–í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è**: 
  - –§—É–Ω–∫—Ü—ñ—è `ei_camera_capture()` —Ç–µ–ø–µ—Ä –ø—Ä–∏–π–º–∞—î –≥–æ—Ç–æ–≤–∏–π frame —è–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä
  - –£—Å—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó –∑ –±—É—Ñ–µ—Ä–æ–º –∫–∞–º–µ—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–æ–≤–∞–Ω—ñ

#### 3. **–í—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å —Ç–∞–π–º–∞—É—Ç—ñ–≤ –Ω–∞ —ñ–Ω—Ñ–µ—Ä–µ–Ω—Ü—ñ—é**
- **–ü—Ä–æ–±–ª–µ–º–∞**: –Ø–∫—â–æ Edge Impulse –º–æ–¥–µ–ª—å –∑–∞–≤–∏—Å–∞–ª–∞, —Å–∏—Å—Ç–µ–º–∞ –±–ª–æ–∫—É–≤–∞–ª–∞—Å—å –Ω–∞–∑–∞–≤–∂–¥–∏
- **–ù–∞—Å–ª—ñ–¥–æ–∫**: –ù–µ–º–∞ —Å–ø–æ—Å–æ–±—É –≤–∏–π—Ç–∏ –∑ "Scanning..." —Å—Ç–∞–Ω—É
- **–í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è**: 
  - –î–æ–¥–∞–Ω–æ –≥–ª–æ–±–∞–ª—å–Ω–∏–π —Ç–∞–π–º–∞—É—Ç 30 —Å–µ–∫—É–Ω–¥ –Ω–∞ —ñ–Ω—Ñ–µ—Ä–µ–Ω—Ü—ñ—é
  - –°–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–≤—ñ—Ä—è—î —Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—å —Ç–∞ –≤–∏–≤–æ–¥–∏—Ç—å –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è

### üü° –û–ü–¢–ò–ú–Ü–ó–ê–¶–Ü–á

#### 1. **–í–∏–¥–∞–ª–µ–Ω–Ω—è FreeRTOS –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π —É stream_handler**
- –ó–∞–º—ñ–Ω–µ–Ω–æ `vTaskDelay(pdMS_TO_TICKS(10))` –Ω–∞ –ø—Ä–æ—Å—Ç–∏–π `delay(10)`
- –ó–∞–ø–æ–±—ñ–≥–∞—î –ø–æ—Ç–µ–Ω—Ü—ñ–π–Ω–∏–º –∫–æ–Ω—Ñ–ª—ñ–∫—Ç–∞–º –∑ FreeRTOS

#### 2. **–ü–æ–∫—Ä–∞—â–µ–Ω–∞ –ª–æ–≥—ñ–∫–∞ –∑–∞–ø–æ–±—ñ–≥–∞–Ω–Ω—è race conditions**
- –î–æ–¥–∞–Ω–æ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É `if (!camera_busy)` –ø–µ—Ä–µ–¥ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è–º frame —É `stream_handler()`
- –°–ø–µ—Ü—ñ–∞–ª—å–Ω–æ –¥–ª—è –∑–∞–ø–æ–±—ñ–≥–∞–Ω–Ω—è –æ–¥–Ω–æ—á–∞—Å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø—É –ø—ñ–¥ —á–∞—Å —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—è

#### 3. **–Ü–º–µ–Ω–æ–≤–∞–Ω—ñ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∏**
```cpp
#define INFERENCE_TIMEOUT 30000UL  // 30 second timeout
```

### üìä –ó–ú–Ü–ù–ò –£ –ö–û–î–ê–•

#### `src/InferenceHandler.h`
```diff
- bool ei_camera_capture(uint32_t img_width, uint32_t img_height)
+ bool ei_camera_capture(camera_fb_t* fb, uint32_t img_width, uint32_t img_height)
  // –¢–µ–ø–µ—Ä –ø—Ä–∏–π–º–∞—î frame —è–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä –∑–∞–º—ñ—Å—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è

- if (!ei_camera_capture(EI_CLASSIFIER_INPUT_WIDTH, EI_CLASSIFIER_INPUT_HEIGHT))
+ if (!ei_camera_capture(fb, EI_CLASSIFIER_INPUT_WIDTH, EI_CLASSIFIER_INPUT_HEIGHT))

+ if (!fb) {
+     Serial.println("‚ùå No frame provided!");
+     return "Invalid frame";
+ }
```

#### `src/WebServerHandler.h`
```diff
- while (res == ESP_OK)
+ while ((res == ESP_OK) && ((millis() - stream_start) < STREAM_TIMEOUT))

- vTaskDelay(pdMS_TO_TICKS(10));
+ delay(10);
```

#### `src/main.cpp`
```diff
+ #define INFERENCE_TIMEOUT 30000UL

+ // Get frame from camera with timeout
+ uint32_t frame_start = millis();
+ camera_fb_t* fb = esp_camera_fb_get();
+ 
+ if (!fb) {
+     Serial.println("‚ùå Failed to get camera frame!");
+     global_result = "Camera Error";
+     camera_busy = false;
+     yield();
+     delay(50);
+     return;
+ }

+ // Check if inference took too long
+ if (inference_time > INFERENCE_TIMEOUT) {
+     Serial.printf("‚ö†Ô∏è  Inference took too long: %ldms\n", inference_time);
+ }
```

### ‚úÖ –†–ï–ó–£–õ–¨–¢–ê–¢

- **–ù–∞—Ç–∏—Å–∫–∞–Ω–Ω—è –∫–Ω–æ–ø–∫–∏ —É –≤–µ–±—ñ** - –≤—ñ–¥—Ä–∞–∑—É –∑–∞–ø—É—Å–∫–∞—î —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—è
- **–í–µ–±-—Å—Ç—Ä–∏–º** - –≤—ñ–¥—Ç–≤–æ—Ä—é—î—Ç—å—Å—è –ø–ª–∞–≤–Ω–æ –±–µ–∑ –∑–∞–≤–∏—Å–∞–Ω–Ω—è
- **–û–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫** - –≤—Å—ñ –ø–æ–º–∏–ª–∫–∏ –≤–∏–≤–æ–¥—è—Ç—å—Å—è —É —Å–µ—Ä—ñ–π–Ω–∏–π –º–æ–Ω—ñ—Ç–æ—Ä
- **–¢–∞–π–º–∞—É—Ç–∏** - —Å–∏—Å—Ç–µ–º–∞ –Ω–µ –∑–∞–≤–∏—Å–∞—î –ø—Ä–∏ –ø–æ–º–∏–ª–∫–∞—Ö Edge Impulse

### üß™ –†–ï–ö–û–ú–ï–ù–î–ê–¶–Ü–á –î–õ–Ø –¢–ï–°–¢–£–í–ê–ù–ù–Ø

1. –í—ñ–¥–∫—Ä–∏–π—Ç–µ —Å–µ—Ä—ñ–π–Ω–∏–π –º–æ–Ω—ñ—Ç–æ—Ä: `115200 baud`
2. –ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ –Ω–æ–≤—É –ø—Ä–æ—à–∏–≤–∫—É
3. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É –∞–±–æ –∫–ª–∞—Ü–Ω—ñ—Ç—å SCAN –Ω–∞ –≤–µ–±—ñ
4. –°–ø–æ—Å—Ç–µ—Ä—ñ–≥–∞–π—Ç–µ –ª–æ–≥–∏:
   ```
   üß† SCAN #1 - Starting inference...
   üì∏ Capturing frame...
   ‚úì JPEG‚ÜíRGB: 45ms
   ‚úì Resize: 12ms
   üß† Running inference...
   ‚úì Inference: 128ms
   
   üì¶ Detected: 1
     [0] 100_UAH: 87%
   ‚úÖ Result: 100_UAH (87%)
   ```

5. –Ø–∫—â–æ –±–∞—á–∏—Ç–µ `‚ùå` –ø–æ–º–∏–ª–∫–∏ - —Ü–µ —Ç–µ–∂ –Ω–æ—Ä–º–∞–ª—å–Ω–æ, –±—É–¥–µ –≤–∏–≤–µ–¥–µ–Ω–æ –¥–µ—Ç–∞–ª—ñ

### üìà –•–ê–†–ê–ö–¢–ï–†–ò–°–¢–ò–ö–ò –ü–†–û–®–ò–í–ö–ò

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–Ω—è |
|----------|----------|
| Flash Usage | 72.7% (952 KB / 1.3 MB) |
| RAM Usage | 17.2% (56 KB / 320 KB) |
| Build Time | 22.10 —Å–µ–∫ |
| Status | ‚úÖ Production Ready |

